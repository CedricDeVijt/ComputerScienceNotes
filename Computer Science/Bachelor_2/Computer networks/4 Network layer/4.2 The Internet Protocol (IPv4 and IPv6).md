## 4.2.1 Key Fields in the IPv4 Datagram
- **Version number**: Specifies the IP protocol version of the datagram. Different versions of IP use different datagram formats.
- **Header length**: Determines where in the IP datagram the payload begins. Represents the length of the header in 32-bit words.
- **Type of service (TOS)**: Allows different types of IP datagrams to be distinguished from each other. Also used for Explicit Congestion Notification.
- **Datagram length**: Total length of the IP datagram (header plus data), measured in bytes.
- **Identifier, flags, fragmentation offset**: Control IP fragmentation for large datagrams. IPv6 does not allow fragmentation.
- **Time-to-live (TTL)**: Ensures datagrams do not circulate forever in the network. Decremented by one each time the datagram is processed by a router.
- **Protocol**: Indicates the specific transport-layer protocol to which the data portion of the IP datagram should be passed.
- **Header checksum**: Detects bit errors in a received IP datagram using 1s complement arithmetic.
- **Source and destination IP addresses**: Identify the source and ultimate destination of the datagram.
- **Options**: Allow extension of the IP header but were not included in IPv6 due to complexity and performance considerations.
- **Data (Payload)**: Contains the transport-layer segment (TCP or UDP) to be delivered to the destination. Can carry other types of data as well.

TCP/IP performs error checking at both the transport and network layers due to differences in checksums and the possibility of different protocol stacks.
## 4.2.2 IP Addressing and Interfaces

### Hosts and Routers
- **Interface**: Boundary between a host/router and the physical link.
- **IP Address**: Each interface has its own IP address.
- **32-Bit Addresses**: Total of 2^32 (or approximately 4 billion) possible IP addresses.
- **Dotted-Decimal Notation**: Each byte of the address is written in decimal form and separated by periods.
- **Example**: IP address 193.32.216.9 corresponds to 11000001 00100000 11011000 00001001 in binary.
### Unique IP Addresses
- Each interface on every host/router in the global Internet must have a globally unique IP address.
- Determined by the subnet to which it is connected.
### Subnet Addressing
- **Subnet**: Interconnects multiple host/router interfaces.
- **Example**: IP address 223.1.1.0/24 defines a subnet with the leftmost 24 bits indicating the subnet address.
- **Host and Router Interfaces**: Assigned addresses within the subnet, such as 223.1.1.1, 223.1.1.2, 223.1.1.3, and 223.1.1.4.
- **Additional Hosts**: Any additional hosts attached to the subnet must have addresses of the form 223.1.1.xxx.
### Example Scenario
- **Topology**: One router with three interfaces interconnecting seven hosts.
- **IP Addresses**: Notice the pattern of IP addresses assigned to host and router interfaces, forming subnets such as 223.1.1.0/24, 223.1.2.0/24, and 223.1.3.0/24.

![[Screenshot 2024-04-04 at 16.13.41.png]]


## 4.2.3 Classless Inter-domain Routing (CIDR)

### Overview
- **CIDR**: Internet's address assignment strategy, pronounced "cider".
- Generalises subnet addressing.
### Address Format
- **Format**: a.b.c.d/x, where x indicates the number of bits in the first part of the address.
- **Network Portion**: x most significant bits, referred to as the prefix or network prefix.
- **Organisation Assignment**: Organisations are assigned a block of contiguous addresses with a common prefix.
- **Forwarding Efficiency**: Only the leading x bits of the address need to be considered for routing, reducing the size of forwarding tables in routers.
### IP Broadcast Address
- **Broadcast Address**: 255.255.255.255
- **Function**: When a host sends a datagram to this address, the message is delivered to all hosts on the same subnet.
- **Router Handling**: Routers optionally forward the message into neighboring subnets as well, although they usually don't.


![[Screenshot 2024-04-04 at 16.15.31.png]]


## 4.2.4 Dynamic Host Configuration Protocol (DHCP)

### Configuration Methods
- **Manual Configuration**: Typically done by a system administrator for routers and hosts, often remotely.
- **DHCP (Dynamic Host Configuration Protocol)**: Allows hosts to obtain IP addresses automatically.
### DHCP Functionality
- **Automatic IP Address Allocation**: DHCP allocates IP addresses to hosts automatically.
- **Static or Dynamic Assignment**: Can configure DHCP to assign the same IP address each time or a temporary one.
- **Additional Information**: DHCP provides subnet mask, default gateway, and DNS server addresses.
### DHCP Process (Four Steps)
1. **DHCP Server Discovery**:
   - Host sends a DHCP discover message to find a DHCP server.
   - Message is broadcast to all nodes using the broadcast destination IP address 255.255.255.255.

2. **DHCP Server Offer(s)**:
   - DHCP server responds with a DHCP offer message broadcasted to all nodes.
   - Offer includes proposed IP address, network mask, and lease time.

3. **DHCP Request**:
   - Host selects an offer and responds with a DHCP request message.

4. **DHCP ACK**:
   - Server confirms the request with a DHCP ACK message.
### Lease Renewal
- DHCP allows clients to renew their lease on an IP address if needed.

![[Screenshot 2024-04-04 at 16.19.25.png]]


## Network Address Translation (NAT)
### Address Allocation Challenges
- **SOHO Subnets**: Small office, home office (SOHO) setups require addressing multiple devices.
- **IP Address Allocation**: Allocating a range of addresses for all devices can be complex.
- **ISP Allocation**: ISP may have already allocated contiguous portions of the SOHO network's address range.
- **Complexity**: Homeowners typically don't want or need to manage IP addresses.
### NAT Operation
- **NAT-enabled Router**: Resides in the home network.
- **Addressing**: All interfaces in the home network share the same subnet address (e.g., 10.0.0.0/24).
- **Reserved Address Spaces**: Portions of the IP address space (e.g., 10.0.0.0/8) are reserved for private networks ([RFC 1918](https://tools.ietf.org/html/rfc1918)).
### NAT Functionality
- **Address Translation**: NAT router appears as a single device with a single IP address to the outside world.
- **Source and Destination IP Addresses**: All traffic leaving the home router for the Internet has a source IP address of the router's public IP.
- **NAT Translation Table**: Router maintains a translation table to map internal hosts to external addresses using port numbers.
### Deployment and Criticisms
- **Widespread Deployment**: NAT is widely used to simplify address allocation in home networks.
- **Detractors**: Criticisms include issues with addressing processes versus hosts, especially for servers behind NAT.
- **NAT Traversal**: Technical solutions like NAT traversal tools ([RFC 5389](https://tools.ietf.org/html/rfc5389)) address some of these problems.

![[Screenshot 2024-04-04 at 16.21.43.png]]


## 4.2.5 Key Fields in the IPv6 Datagram
- **Version**: 4-bit field indicating the IP version number. IPv6 carries a value of 6.
- **Traffic Class**: 8-bit field for prioritizing datagrams within a flow or from certain applications.
- **Flow Label**: 20-bit field used to identify a flow of datagrams.
- **Payload Length**: 16-bit value indicating the number of bytes in the IPv6 datagram.
- **Next Header**: Identifies the protocol to which the data will be delivered (e.g., TCP or UDP).
- **Hop Limit**: Contents decremented by each router forwarding the datagram. Discarded if count reaches zero.
- **Source and Destination Addresses**: Defined in RFC 4291, utilizing various formats of the IPv6 128-bit address.
- **Data**: Payload portion of the IPv6 datagram, passed to the protocol specified in the next header field.

![[Screenshot 2024-04-04 at 16.24.36.png]]

## 4.2.6 IPv4-to-IPv6 Transition: Tunneling

### Approach
- **Most Widely Adopted Method**: Transition involves tunneling ([RFC 4213](https://tools.ietf.org/html/rfc4213)).
- **Basic Idea**: IPv6 nodes connected by intervening IPv4 routers create a tunnel.
### Tunnelling Process
1. **IPv6 Nodes**: Nodes B and E want to interoperate using IPv6 datagrams but are connected by IPv4 routers.
2. **Tunnel Creation**: Intervening IPv4 routers between B and E form a tunnel.
3. **Tunneling Process**:
   - Node B encapsulates the entire IPv6 datagram into the data (payload) field of an IPv4 datagram.
   - The IPv4 datagram is addressed to node E and sent to the first node in the tunnel, node C.
   - Intervening IPv4 routers route the IPv4 datagram among themselves, unaware that it contains a complete IPv6 datagram.
4. **Receiving Side**:
   - Node E receives the IPv4 datagram (destination of the IPv4 datagram).
   - It observes the protocol number field in the IPv4 datagram (41), indicating that the payload is an IPv6 datagram.
   - Node E extracts the IPv6 datagram and routes it as if it were received from a directly connected IPv6 neighbor.
### Result
- IPv6 datagrams are successfully transmitted between nodes B and E through the tunnel formed by intervening IPv4 routers.

![[Screenshot 2024-04-04 at 16.25.52.png]]

